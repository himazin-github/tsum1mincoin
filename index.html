<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ツムツム効率計算・完全保存版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --tsum-yellow: #ffcf00; --tsum-brown: #5d4037; --bg-color: #fff9c4; }
        body { font-family: sans-serif; background: var(--bg-color); color: var(--tsum-brown); margin: 0; padding: 5px; display: flex; flex-direction: column; align-items: center; }
        .main-container { width: 100%; max-width: 450px; background: white; border-radius: 15px; padding: 10px; box-sizing: border-box; }
        
        .calc-header { background: var(--tsum-yellow); padding: 8px; border-radius: 10px; text-align: center; margin-bottom: 8px; font-weight: bold; }
        .input-card { background: #fffef0; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
        
        .play-selector { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--tsum-yellow); }
        
        #entries-container { max-height: 180px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #f0f0f0; border-radius: 8px; background: #fff; }
        .entry-row { display: flex; align-items: center; gap: 5px; padding: 4px; border-bottom: 1px solid #eee; }
        .entry-num { font-size: 10px; width: 15px; text-align: center; color: #999; }
        input[type="number"], input[type="text"], select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; }

        .info-row { margin-bottom: 10px; display: flex; flex-direction: column; }
        .info-row label { font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #8d6e63; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 15px; }
        #add-btn { background: #00a0e9; color: white; box-shadow: 0 3px 0 #0077b3; }
        #download-btn { background: #4caf50; color: white; box-shadow: 0 3px 0 #388e3c; }
        
        /* 表の表示設定：画面上ではスクロール可能にする */
        .table-wrap { width: 100%; overflow-x: auto; margin-top: 10px; background: white; border-radius: 8px; }
        #capture-area { display: inline-block; min-width: 100%; }
        table { width: 100%; border-collapse: collapse; min-width: 440px; background: white; }
        th, td { border: 1px solid #ddd; padding: 6px 2px; text-align: center; font-size: 10px; }
        th { background: #f8f8f8; }
        .tsum-thumb { width: 40px; height: 40px; object-fit: cover; display: block; margin: auto; border-radius: 4px; }
        .delete-btn { padding: 4px 6px; background: #ff5252; color: white; border: none; border-radius: 4px; font-size: 9px; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="calc-header">
        平均効率: <span id="calc-result">0</span> 枚/分
    </div>

    <div class="input-card">
        <div class="play-selector">
            <label>プレイ回数</label>
            <select id="play-count-selector" onchange="generateEntryRows()"></select>
        </div>
        <div id="entries-container"></div>

        <div class="info-row"><label>アイテム設定</label>
            <select id="t-item" onchange="autoCalc()">
                <option value="2300" data-label="5-4+C">5→4 + Coin (2300)</option>
                <option value="3800" data-label="5-4+C+B">5→4 + Coin + Bomb (3800)</option>
                <option value="500" data-label="Coin">Coinのみ (500)</option>
            </select>
        </div>
        <div class="info-row"><label>ツム画像</label><input type="file" id="t-img" accept="image/*"></div>
        <div class="info-row"><label>ツム名</label><input type="text" id="t-name" placeholder="ナミネ"></div>
        <div class="info-row"><label>スキルレベル (SL)</label>
            <select id="t-skill"><option>6</option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
        </div>

        <button id="add-btn">リストに保存</button>
        <button id="download-btn">表全体を画像で保存</button>
    </div>

    <div class="table-wrap">
        <div id="capture-area">
            <table id="targetTable">
                <thead>
                    <tr>
                        <th style="width:25px">No</th>
                        <th style="width:45px">画像</th>
                        <th>ツム名</th>
                        <th style="width:25px">SL</th>
                        <th style="width:50px">アイテム</th>
                        <th style="width:40px">時間</th>
                        <th style="width:65px">枚/分</th>
                        <th data-html2canvas-ignore style="width:30px">消</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const playCountSel = document.getElementById('play-count-selector');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.querySelector('#targetTable tbody');

    for(let i=1; i<=15; i++) playCountSel.add(new Option(i + "回平均", i));
    playCountSel.value = 5;

    function generateEntryRows() {
        const count = parseInt(playCountSel.value);
        entriesContainer.innerHTML = "";
        for(let i=1; i<=count; i++) {
            const row = document.createElement('div');
            row.className = "entry-row";
            row.innerHTML = `<div class="entry-num">${i}</div><input type="number" class="c-coin" placeholder="コイン数" oninput="autoCalc()" style="flex:1.2;" inputmode="numeric"><select class="c-min" onchange="autoCalc()">${genOptions(10,2)}分</select><select class="c-sec" onchange="autoCalc()">${genOptions(59,30)}秒</select>`;
            entriesContainer.appendChild(row);
        }
        autoCalc();
    }

    function genOptions(max, def) {
        let h = "";
        for(let i=0; i<=max; i++) h += `<option value="${i}" ${i===def?'selected':''}>${i}</option>`;
        return h;
    }

    function autoCalc() {
        const coins = document.querySelectorAll('.c-coin'), mins = document.querySelectorAll('.c-min'), secs = document.querySelectorAll('.c-sec');
        let profit = 0, time = 0, cnt = 0;
        const cost = parseInt(document.getElementById('t-item').value);
        coins.forEach((input, i) => {
            if(input.value) {
                profit += (parseFloat(input.value) * 1.3) - cost;
                time += (parseInt(mins[i].value) * 60) + parseInt(secs[i].value);
                cnt++;
            }
        });
        if (cnt > 0 && time > 0) {
            const eff = Math.round(profit / time * 60);
            document.getElementById('calc-result').innerText = eff.toLocaleString();
            return { eff, avg: Math.round(time / cnt) };
        }
        document.getElementById('calc-result').innerText = "0"; return null;
    }

    document.getElementById('add-btn').addEventListener('click', () => {
        const res = autoCalc(); if(!res) return alert("コイン数を入力してね");
        const name = document.getElementById('t-name').value || "---";
        const sl = document.getElementById('t-skill').value;
        const itemLabel = document.getElementById('t-item').options[document.getElementById('t-item').selectedIndex].getAttribute('data-label');
        const imgFile = document.getElementById('t-img').files[0];
        const timeStr = `${Math.floor(res.avg/60)}:${(res.avg%60).toString().padStart(2,'0')}`;

        const save = (imgData) => {
            const data = JSON.parse(localStorage.getItem('tsumData') || '[]');
            data.push({ name, sl, item: itemLabel, time: timeStr, eff: res.eff, imgData });
            localStorage.setItem('tsumData', JSON.stringify(data));
            renderTable();
        };

        if (imgFile) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(imgFile);
        } else { save(null); }
    });

    function renderTable() {
        tableBody.innerHTML = "";
        const data = JSON.parse(localStorage.getItem('tsumData') || '[]');
        data.forEach((d, i) => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td>${i+1}</td><td>${d.imgData?`<img src="${d.imgData}" class="tsum-thumb">`:''}</td><td style="text-align:left; padding-left:3px;">${d.name}</td><td>${d.sl}</td><td style="font-size:8px;">${d.item}</td><td>${d.time}</td><td style="font-weight:bold">${d.eff.toLocaleString()}</td><td data-html2canvas-ignore><button class="delete-btn" onclick="deleteItem(${i})">✕</button></td>`;
        });
    }

    function deleteItem(i) {
        if(confirm("消す？")) {
            const data = JSON.parse(localStorage.getItem('tsumData') || '[]');
            data.splice(i, 1);
            localStorage.setItem('tsumData', JSON.stringify(data));
            renderTable();
        }
    }

    // 保存ボタンの処理を強化
    document.getElementById('download-btn').addEventListener('click', () => {
        const target = document.getElementById('capture-area');
        
        // 保存時だけ一時的にスタイルを変更して見切れを防ぐ
        const originalStyle = target.style.cssText;
        target.style.width = "auto";
        target.style.overflow = "visible";
        target.style.display = "block";

        html2canvas(target, {
            useCORS: true,
            scale: 2, // 高画質
            backgroundColor: "#ffffff",
            width: target.scrollWidth, // 全体の幅
            height: target.scrollHeight // 全体の高さ
        }).then(canvas => {
            target.style.cssText = originalStyle; // 元に戻す
            const link = document.createElement('a');
            link.download = 'tsum-data.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    });

    generateEntryRows();
    renderTable();
</script>

</body>
</html>

